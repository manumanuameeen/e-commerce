<%- include("../../views/partials/users/header") %>

    <style>
        .breadcrumb-wrap {
            background-color: #000000;
            padding: 15px 0;
            margin-bottom: 30px;
        }

        .page-header {
            margin-bottom: 20px;
            background-color: #f1f1f1;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
        }
        .breadcrumb_iner_item p {
  font-size: 15px;
  color: #000;
}
        .breadcrumb a {
            color: #1b1b1c;
            text-decoration: none;
            font-size: 16px;
        }

        .breadcrumb span {
            margin: 0 5px;
            color:black;
        }

        .cart-section {
            padding: 60px 0;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .cart-table {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .cart-table table {
            width: 100%;
            border-collapse: collapse;
        }


        .cart-table th {
            font-size: 16px;
            color: #333;
            padding: 20px 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        a {
            color: black;
        }

        a:hover {
            color: #c0c1c2;
        }


        .cart-table th:first-child {
            text-align: center;
            width: 200px;
        }

        .cart-table th.size-column {
            width: 10%;
        }

        .cart-table th.price-column {
            width: 15%;
        }

        .cart-table th.quantity-column {
            width: 20%;
        }

        .cart-table th.subtotal-column {
            width: 15%;
        }

        .cart-table th.remove-column {
            width: 10%;
        }

        .cart-table th:last-child {
            width: 50px;
        }

        .cart-table td {
            padding: 20px;
            vertical-align: middle;
            text-align: center;
            font-size: 16px;
        }

        .cart-table td:first-child {
            text-align: center;
        }


        .cart-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 0 10px;
        }


        .cart-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-bottom: 5px;
        }

        .item-details {
            text-align: center;
            width: 100%;
        }

        .item-details h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
            line-height: 1.2;
        }

        .size-info {
            color: #666;
            font-size: 14px;
            margin: 4px 0;
        }

        .item-price {
            color: #666;
            font-size: 16px;
            display: block;
            margin-top: 4px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 120px;
            margin: 0 auto;
        }

        .quantity-controls button {
            width: 35px;
            height: 35px;
            border: none;
            background: #f8f8f8;
            cursor: pointer;
            font-size: 16px;
        }

        .quantity-controls input {
            width: 50px;
            height: 35px;
            border: none;
            text-align: center;
            font-size: 16px;
        }

        .remove-item {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
        }

        .cart-summary {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
        }

        .summary-total {
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
        }

        .btn-continue {
            background: #f8f8f8;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-checkout {
            background: #333;
            color: white;
            width: 100%;
            margin-top: 20px;
            font-weight: 600;
        }

        .cart-actions {
            display: flex;
            justify-content: flex-start;
            margin-top: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 350px;
            animation: slideIn 0.5s ease-out;
        }

        .notification-content {
            background-color: #fff;
            color: #333;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .notification.success .notification-content {
            background-color: #4CAF50;
            color: white;
        }

        .notification.error .notification-content {
            background-color: #f44336;
            color: white;
        }

        .close-notification {
            background: none;
            border: none;
            color: inherit;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .cart-grid {
                flex-direction: column;
            }

            .cart-table {
                margin-bottom: 20px;
            }

            .cart-table td {
                display: block;
                text-align: center;
                padding: 10px;
            }

            .cart-table thead {
                display: none;
            }
        }
    </style>

<style>
    .breadcrumb_bg {
      background: #f8f8f8;
      padding: 40px 0;
      margin-bottom: 30px;
      /* background-image: url('https://i.pinimg.com/736x/5a/1a/85/5a1a85ad7afacac679bfdda2d06ba7e5.jpg'); */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
  }
  
      .breadcrumb_iner {
          text-align: left;
          padding: 0 15px;
      }
  
      .breadcrumb_iner_item h2 {
          font-size: 32px;
          font-weight: 600;
          margin-bottom: 8px;
          color: #000000;  /* Changed to pure black */
      }
  
      .breadcrumb_iner_item p {
          font-size: 14px;
          color: #000000;  /* Changed to pure black */
          margin: 0;
      }
  
      .breadcrumb_iner_item p span {
          margin: 0 8px;
          color: #000000;  /* Changed to pure black and fixed the syntax error */
      }
  
      .breadcrumb_iner_item a {
          color: #000000;  /* Added this to ensure links are also black */
          text-decoration: none;
      }
  
      .breadcrumb_iner_item a:hover {
          color: #333333;  /* Slightly lighter black on hover */
      }
  </style>

<section class="breadcrumb breadcrumb_bg">
    <div class="container">
        <div class="breadcrumb_iner">
            <div class="breadcrumb_iner_item">
                <h2>Cart</h2>
                <p class="breadcrumb_iner_item p">Home <span>-</span> Shop <span>-</span> Cart</p>
            </div>
        </div>
    </div>
</section>




    <section class="cart-section">
        <div class="container">
            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                <div style="flex: 1 1 65%;">
                    <div class="cart-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="min-width: 200px;">Product</th>
                                    <th class="size-column">Size</th>
                                    <th class="price-column">Price</th>
                                    <th class="quantity-column">Quantity</th>
                                    <th class="subtotal-column">Subtotal</th>
                                    <th class="remove-column">Remove</th>
                                </tr>
                            </thead>
                            <tbody>
                                <%if(cart.length> 0){%>
                                    <% cart.forEach(items=> {%>
                                        <tr data-cart-item-id="<%= items._id %>">
                                            <td>
                                                <div class="cart-item">

                                                  
                                                    <img src="/uploads/re-image/<%=items.ProductId.productImage[0]%>" alt="product image">
                                                 
                                                    <div class="item-details">
                                                        <h4>
                                                            <%=items.ProductId.productName || 'Product not found' %>
                                                        </h4>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <%=items.colorVariant|| 'NO color' %>
                                            </td>
                                            <td>₹ <%= items.ProductId.salePrice || 'Price not available' %>
                                            </td>
                                            <td>
                                                <div class="quantity-controls">
                                                    <button>-</button>
                                                    <input type="text" value="<%=items.quantity%>">
                                                    <button>+</button>
                                                </div>
                                            </td>
                                            <td>₹ <%=items.totalPrice || 'N/A' %>
                                            </td>
                                            <td><button class="remove-item">×</button></td>
                                        </tr>
                                        <tr data-cart-item-id="<%= items._id %>" data-color="<%= items.colorVariant %>" data-product-id="<%= items.ProductId._id %>"></tr>
                                        <%})%>
                                            <%}else{%>
                                                <tr>
                                                    <td colspan="6" class="text-center">
                                                        <p class="lead mb-4">No items found in Cart</p>
                                                    </td>
                                                </tr>
                                                <%}%>
                            </tbody>
                        </table>
                    </div>
                    <div id="notification" class="notification" style="display: none;">
                        <div class="notification-content">
                            <span id="notification-message"></span>
                            <button class="close-notification">×</button>
                        </div>
                    </div>

                    <div class="cart-actions">
                        <button class="btn btn-continue"><a href="/shop" rel="nofollow">Continue Shopping</a></button>
                    </div>
                </div>

                <div style="flex: 1 1 30%;">
                    <div class="cart-summary">
                        <h3 style="font-size: 18px; margin-bottom: 20px;">Cart Totals</h3>
                        <div class="summary-item">
                            <span>Subtotal</span>
                            <span>₹ <%=cart.reduce((acc,items)=>acc+items.totalPrice,0).toFixed(2)%></span>
                        </div>
                        <div class="summary-item">
                            <span>Shipping</span>
                            <span>Free</span>
                        </div>
                        <div class="summary-total">
                            <span>Total</span>
                            <span>₹ <%=cart.reduce((acc,items)=>acc+items.totalPrice,0).toFixed(2)%></span>
                        </div>
                        <a class="btn btn-checkout" href="/checkout">Proceed to
                                Checkout</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>

document.querySelectorAll('.quantity-controls button').forEach(button => {
    button.addEventListener('click', async (e) => {
        const row = e.target.closest('tr');
        const cartItemId = row.getAttribute('data-cart-item-id');
        const inputField = row.querySelector('input[type="text"]');
        if (!inputField) return;
        
        let currentQuantity = parseInt(inputField.value);
        const isIncrement = e.target.textContent === '+';
        let newQuantity = isIncrement ? currentQuantity + 1 : currentQuantity - 1;

        // Basic client-side validation
        if (newQuantity < 1) {
            showNotification('Minimum quantity is 1', 'error');
            return;
        }

        if (newQuantity > 5) {
            showNotification('Maximum quantity per item is 5', 'error');
            return;
        }

       
        const totalCartItems = Array.from(document.querySelectorAll('.quantity-controls input'))
            .reduce((sum, input) => {
                if (input === inputField) return sum + newQuantity;
                return sum + parseInt(input.value);
            }, 0);

        if (totalCartItems > 10) {
            showNotification('Maximum 10 items allowed in cart', 'error');
            return;
        }

        try {
            const response = await fetch(`/updateQuantity/${cartItemId}`, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quantity: newQuantity })
            });

            const data = await response.json();

            if (!response.ok) {
                showNotification(data.message, 'error');
                return;
            }

            if (data.status) {
                if (data.removed) {
                    row.remove();
                    showNotification('Item removed from cart');
                } else {
                    inputField.value = newQuantity;
                    const subtotalCell = row.querySelector('td:nth-child(5)');
                    subtotalCell.textContent = `₹ ${data.newTotal}`;
                }
                updateCartSummary();
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error updating cart', 'error');
            inputField.value = currentQuantity; 
        }
    });
});

document.querySelectorAll('.quantity-controls input').forEach(input => {
    input.addEventListener('change', async (e) => {
        const row = e.target.closest('tr');
        const cartItemId = row.getAttribute('data-cart-item-id');
        const originalValue = parseInt(e.target.getAttribute('data-original-value'));
        let newQuantity = parseInt(e.target.value);

        if (isNaN(newQuantity)) {
            e.target.value = originalValue;
            showNotification('Please enter a valid number', 'error');
            return;
        }

        if (newQuantity > 5) {
            e.target.value = originalValue;
            showNotification('Maximum quantity per item is 5', 'error');
            return;
        }

        if (newQuantity < 1) {
            e.target.value = originalValue;
            showNotification('Minimum quantity is 1', 'error');
            return;
        }

        try {
            const response = await fetch(`/updateQuantity/${cartItemId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: newQuantity })
            });

            const data = await response.json();

            if (!response.ok) {
                e.target.value = originalValue;
                showNotification(data.message, 'error');
                return;
            }

            if (data.status) {
                if (data.removed) {
                    row.remove();
                    showNotification('Item removed from cart');
                } else {
                    const subtotalCell = row.querySelector('td:nth-child(5)');
                    subtotalCell.textContent = `₹ ${data.newTotal}`;
                    e.target.setAttribute('data-original-value', newQuantity);
                }
                updateCartSummary();
            }
        } catch (error) {
            console.error('Error:', error);
            e.target.value = originalValue;
            showNotification('Error updating cart', 'error');
        }
    });

    input.addEventListener('focus', (e) => {
        e.target.setAttribute('data-original-value', e.target.value);
    });
});

const updateCartQuantity = async (req, res) => {
    try {
        const { cartItemId } = req.params;
        const { quantity } = req.body;
        
        const cart = await Cart.findOne({ userId: req.session.user })
            .populate('items.ProductId');  
            
        if (!cart) {
            return res.status(404).json({
                status: false,
                message: 'Cart not found'
            });
        }

        const cartItem = cart.items.find(item => item._id.toString() === cartItemId);
        if (!cartItem) {
            return res.status(404).json({
                status: false,
                message: 'Item not found in cart'
            });
        }

        if (quantity <= 0) {
            cart.items = cart.items.filter(item => item._id.toString() !== cartItemId);
            await cart.save();
            return res.json({
                status: true,
                removed: true,
                message: 'Item removed from cart'
            });
        }

        const product = await Product.findById(cartItem.ProductId);
        if (!product) {
            return res.status(404).json({
                status: false,
                message: 'Product not found'
            });
        }

        const colorVariant = product.colorVariants.find(
            variant => variant.color === cartItem.colorVariant
        );

        if (!colorVariant) {
            return res.status(404).json({
                status: false,
                message: 'Selected color variant not found'
            });
        }

        if (quantity > colorVariant.quantity) {
            return res.status(statusCode.BAD_REQUEST).json({
                status: false,
                message: `Only ${colorVariant.quantity} items are available in ${cartItem.colorVariant} color`
            });
        }

        if (quantity > 5) {
            return res.status(statusCode.BAD_REQUEST).json({
                status: false,
                message: 'Maximum quantity allowed is 5 items'
            });
        }

        const totalCartItems = cart.items.reduce((sum, item) => {
            if (item._id.toString() === cartItemId) {
                return sum + quantity;
            }
            return sum + item.quantity;
        }, 0);

        if (totalCartItems > 10) {
            return res.status(statusCode.BAD_REQUEST).json({
                status: false,
                message: 'Maximum 10 items allowed in cart'
            });
        }

       
        cartItem.quantity = quantity;
        cartItem.totalPrice = product.salePrice * quantity;
        await cart.save();

        return res.json({
            status: true,
            newTotal: cartItem.totalPrice.toFixed(2)
        });

    } catch (error) {
        console.error('Update cart error:', error);
        return res.status(500).json({
            status: false,
            message: 'Error updating cart'
        });
    }
};


function updateCartSummary() {
    const subtotals = Array.from(document.querySelectorAll('.cart-table tbody tr'))
        .map(row => {
            const subtotalText = row.querySelector('td:nth-child(5)')?.textContent;
            return subtotalText ? parseFloat(subtotalText.replace('₹', '').trim()) : 0;
        })
        .filter(value => !isNaN(value));

    const newTotal = subtotals.reduce((sum, value) => sum + value, 0);

    const summarySubtotal = document.querySelector('.summary-item span:last-child');
    const summaryTotal = document.querySelector('.summary-total span:last-child');

    if (summarySubtotal && summaryTotal) {
        const formattedTotal = newTotal.toFixed(2);
        summarySubtotal.textContent = `₹ ${formattedTotal}`;
        summaryTotal.textContent = `₹ ${formattedTotal}`;
    }

    // Update cart count if it exists
    const cartCount = document.querySelector('.cart-count');
    if (cartCount) {
        const totalItems = Array.from(document.querySelectorAll('.quantity-controls input'))
            .reduce((sum, input) => sum + parseInt(input.value), 0);
        cartCount.textContent = totalItems;
    }
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const messageElement = document.getElementById('notification-message');

    messageElement.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';

    // Auto-hide after 3 seconds
    const timeout = setTimeout(() => {
        hideNotification();
    }, 3000);

    // Allow manual close
    document.querySelector('.close-notification').onclick = () => {
        clearTimeout(timeout);
        hideNotification();
    };
}

function hideNotification() {
    const notification = document.getElementById('notification');
    notification.style.animation = 'slideOut 0.5s ease-out';
    setTimeout(() => {
        notification.style.display = 'none';
        notification.style.animation = 'slideIn 0.5s ease-out';
    }, 500);
}


document.addEventListener('DOMContentLoaded', () => {
    updateCartSummary();
    
    document.querySelectorAll('.quantity-controls input').forEach(input => {
        input.setAttribute('data-original-value', input.value);
    });
});



document.querySelectorAll('.remove-item').forEach(button => {
    button.addEventListener('click', async (e) => {
        const row = e.target.closest('tr');
        const cartItemId = row.getAttribute('data-cart-item-id');
        
        try {
            const response = await fetch(`/removeFromCart/${cartItemId}`, {
                method: 'DELETE'
            }); 
            
            const data = await response.json();
            
            if (data.status) {
                row.nextElementSibling?.remove();
                row.remove();
                showNotification('Item removed from cart successfully');
                updateCartSummary();
                
                if (document.querySelectorAll('.cart-table tbody tr').length === 0) {
                    const emptyRow = `
                        <tr>
                            <td colspan="6" class="text-center">
                                <p class="lead mb-4">No items found in Cart</p>
                            </td>
                        </tr>`;
                    document.querySelector('.cart-table tbody').innerHTML = emptyRow;
                }
            } else {
                showNotification(data.message || 'Failed to remove item', 'error');
            }
        } catch (error) {
            console.error('Error removing item:', error);
            showNotification('Error removing item from cart', 'error');
        }
    });
});


  </script>