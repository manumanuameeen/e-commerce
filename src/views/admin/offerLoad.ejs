<%- include('../partials/admin/header') %>
<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"> -->
<!--  -->

<style>

.pagination-container {
    padding: 15px 0;
}

.pagination-container a {
    text-decoration: none;
    margin: 0 5px;
}

.current-page {
    font-weight: bold;
    padding: 5px 10px;
}

.pagination-container a:hover {
    text-decoration: underline;
}
</style>
<br>
<div class="main-content container py-4">
    <br><br>
    <div class="card">
        <div class="row">
            <div class="col-12">
                <div class="content-header d-flex justify-content-between align-items-center" style="padding-right: 20px; padding-top: 20px;">
                    <h2 class="content-title" style="padding-left: 20px; padding-top: 20px;">Offers List</h2>
                    <a href="/admin/offer" class="btn btn-primary">Add New Offer</a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Offer Name</th>
                            <th>Type</th>
                            <!-- <th>name</th> -->
                            <th>Discount (%)</th>
                            <th>Applied To</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th style="min-width: 160px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% offers.forEach(offer => { %>
                            <tr>
                                <td><%= offer.name %></td>
                                <td><%= offer.type.charAt(0).toUpperCase() + offer.type.slice(1) %></td>
                               
                                <td><%= offer.discount %>%</td>
                                <td>
                                    <% if (offer.type === 'product') { %>
                                        <%= offer.productId %>
                                    <% } else if (offer.type === 'category') { %>
                                        <%= offer.categoryId %>
                                    <% } else { %>
                                        <%= offer.referralCode %>
                                    <% } %>
                                </td>
                                <td><%= new Date(offer.startDate).toLocaleDateString() %></td>
                                <td><%= new Date(offer.endDate).toLocaleDateString() %></td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-primary" style="width: 70px;" onclick="editOffer('<%= JSON.stringify(offer) %>')">
                                            Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger" style="width: 70px;" onclick="removeOffer('<%= offer._id %>')">
                                            Remove
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <div class="pagination-container" style="margin-top: 20px; text-align: center;">
                <% if (currentPage > 1) { %>
                    <a href="?page=<%= currentPage - 1 %>" class="btn btn-sm btn-outline-primary">« Previous</a>
                <% } %>

                <% for (let i = 1; i <= totalPages; i++) { %>
                    <% if (i === currentPage) { %>
                        <span class="current-page btn btn-sm btn-primary mx-1" style="cursor: default;">
                            <%= i %>
                        </span>
                    <% } else { %>
                        <a href="?page=<%= i %>" class="btn btn-sm btn-outline-primary mx-1">
                            <%= i %>
                        </a>
                    <% } %>
                <% } %>

                <% if (currentPage < totalPages) { %>
                    <a href="?page=<%= currentPage + 1 %>" class="btn btn-sm btn-outline-primary">Next »</a>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Edit Offer Modal -->
<div class="modal fade" id="editOfferModal" tabindex="-1" aria-labelledby="editOfferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editOfferModalLabel">Edit Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editOfferForm">
                    <input type="hidden" id="editOfferId">
                    <!-- <div class="mb-3">
                        <label for="editOfferName" class="form-label">Offer Name</label>
                        <input type="text" class="form-control" id="editOfferName" required>
                    </div> -->
                    <div class="mb-3"> 
                        <label for="editOfferType" class="form-label">Type</label>
                        <select class="form-control" id="editOfferType" required>
                            <option value="product">Product</option>
                            <option value="category">Category</option>
                            <option value="referral">Referral</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editOfferDiscount" class="form-label">Discount (%)</label>
                        <input type="number" class="form-control" id="editOfferDiscount" required>
                    </div>
                    <div class="mb-3">
                        <label for="editOfferStartDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="editOfferStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editOfferEndDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="editOfferEndDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateOffer()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function editOffer(offerData) {
    const offer = JSON.parse(offerData);
    
    document.getElementById('editOfferId').value = offer._id;
    // document.getElementById('editOfferName').value = offer.name;
    // document.getElementById('editOfferType').value = offer.type;
    document.getElementById('editOfferDiscount').value = offer.discount;
    document.getElementById('editOfferStartDate').value = new Date(offer.startDate).toISOString().split('T')[0];
    document.getElementById('editOfferEndDate').value = new Date(offer.endDate).toISOString().split('T')[0];
    
    
    const modal = new bootstrap.Modal(document.getElementById('editOfferModal'));
    modal.show();
}

function updateOffer() {
    const offerId = document.getElementById('editOfferId').value;
    const updatedOffer = {
        discount: document.getElementById('editOfferDiscount').value,
        startDate: document.getElementById('editOfferStartDate').value,
        endDate: document.getElementById('editOfferEndDate').value
    };

    fetch(`/admin/update-offer/${offerId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedOffer)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Updated!', 'Offer has been updated successfully.', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            Swal.fire('Error!', data.message || 'Something went wrong!', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error!', 'Something went wrong!', 'error');
    });
}

function removeOffer(offerId) {
    console.log(offerId);
    
    Swal.fire({
        title: 'Are you sure?',
        text: 'You won\'t be able to revert this!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/admin/remove-offer/${offerId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Deleted!', data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    Swal.fire('Error!', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error!', 'Something went wrong!', 'error');
            });
        }
    });
}
</script>